{{template "head" .}}
<style>
    td.col1, 
    td.col2,
    .right{
        text-align: right;
    }
</style>
{{template "body" .}}
{{template "content" .}}

<h1>Statistiques</h1>

<section>
    <form id="form" name="form" action="/stats" method="post">

        Mode<br>
        {{if .Checked}}
            <span id="mode">Le mode <code>Données validées uniquement</code> est activé.</span>
        {{else}}
            <span id="mode">Le mode <code>Toutes les données</code> est activé.</span>
        {{end}}
        <label for="switchMode">
            Toutes les données
            <!-- plus square -->
            <svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="/img/icons.svg#feather-plus-square"></use></svg>
            {{if .Checked}}
                <input type="checkbox" id="switchMode" name="switchMode" role="switch" checked />
            {{else}}
                <input type="checkbox" id="switchMode" name="switchMode" role="switch" />
            {{end}}
            <!-- green check square -->
            <svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="/img/icons.svg#feather-green-check-square"></use></svg>
            Données validées uniquement
        </label>

    </form>
</section>

<section id="stats">
    <div>
        <figure>
            <h5>Comptes</h5>
            <table role="grid">
                <thead>
                    <tr>
                        <th scope="col">Compte</th>
                        <th scope="col" class="right">Prix</th>
                        <th scope="col" class="right">Quantite</th>
                    </tr>
                </thead>
                <tbody>
                    {{range $A := .AccountList}}
                        <tr>
                        {{range $i, $v := $A}} 
                            <td class="col{{$i}}">{{$v}}</td>
                        {{end}}
                        </tr>
                    {{end}}
                    <tr>
                        <td>---</td>
                        <td class="right">---</td>
                        <td class="right">---</td>
                    </tr>
                    <tr>
                        <td>TOTAUX</td>
                        {{range $i, $v := .Total}} 
                            <td class="right">{{$v}}</td>
                        {{end}}
                    </tr>
                </tbody>
            </table>
        </figure>
    </div>
    <div>
        <figure>
            <h5>Categories</h5>
            <table role="grid">
                <thead>
                    <tr>
                        <th scope="col">Categorie</th>
                        <th scope="col" class="right">Prix</th>
                        <th scope="col" class="right">Quantite</th>
                    </tr>
                </thead>
                <tbody>
                    {{range $C := .CategoryList}}
                        <tr>
                        {{range $i, $v := $C}} 
                            <td class="col{{$i}}">{{$v}}</td>
                        {{end}}
                        </tr>
                    {{end}}
                </tbody>
            </table>
        </figure>
    </div>
</section>

<div id="container"></div>

{{template "footer" .}}
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script type="module">

    /*const data = [
        {name: "<5", value: 19912018},
        {name: "5-9", value: 20501982},
        {name: "10-14", value: 20679786}
    ];*/
    const data = JSON.parse("{{.ResponseJsonString}}");
    //console.log(data);

    // Specify the chart’s dimensions.
    const width = 928;
    const height = Math.min(width, 500);

    // Create the color scale.
    const color = d3.scaleOrdinal()
        //.domain(data.map(d => d.name))
        .domain(data.map(d => d["name"]))
        .range(d3.quantize(t => d3.interpolateSpectral(t * 0.8 + 0.1), data.length).reverse())

    // Create the pie layout and arc generator.
    const pie = d3.pie()
        .sort(null)
        .value(d => d.value);

    const arc = d3.arc()
        .innerRadius(0)
        .outerRadius(Math.min(width, height) / 2 - 1);

    const labelRadius = arc.outerRadius()() * 0.8;

    // A separate arc generator for labels.
    const arcLabel = d3.arc()
        .innerRadius(labelRadius)
        .outerRadius(labelRadius);

    const arcs = pie(data);

    // Create the SVG container.
    const svg = d3.create("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("viewBox", [-width / 2, -height / 2, width, height])
        .attr("style", "max-width: 100%; height: auto; font: 8px sans-serif; color: black;");

    // Add a sector path for each value.
    svg.append("g")
        .attr("stroke", "white")
        .selectAll()
        .data(arcs)
        .join("path")
        .attr("fill", d => color(d.data.name))
        .attr("d", arc)
        .append("title")
        .text(d => `${d.data.name}: ${d.data.value.toLocaleString("en-US")}`);

    // Create a new arc generator to place a label close to the edge.
    // The label shows the value if there is enough room.
    svg.append("g")
        .attr("text-anchor", "middle")
        .selectAll()
        .data(arcs)
        .join("text")
        .attr("transform", d => `translate(${arcLabel.centroid(d)})`)
        .call(text => text.append("tspan")
            .attr("y", "-0.4em")
            .attr("font-weight", "bold")
            .text(d => d.data.name))
        .call(text => text.filter(d => (d.endAngle - d.startAngle) > 0.25).append("tspan")
            .attr("x", 0)
            .attr("y", "0.7em")
            .attr("fill-opacity", 0.7)
            .text(d => d.data.value.toLocaleString("en-US")));

    container.append(svg.node());

</script>
<script>
    document.getElementById('switchMode').addEventListener('click', function(toggleSwitchMode){
        document.getElementById("form").submit();
    });
</script>