{{template "head" .}}
<style>
    td.col1, 
    td.col2,
    .right{
        text-align: right;
    }
    div#container{
        text-align: center;
    }
</style>
{{template "body" .}}
{{template "content" .}}

<h1>Statistiques</h1>

<section>
    <form id="form" name="form" action="/stats" method="post">
        <div class="grid">
            <div>
                <b>Mode d'affichage des données</b><br>
                {{if .Checked}}
                    <span id="mode">Le mode <code>Données validées</code> est activé.</span>
                {{else}}
                    <span id="mode">Le mode <code>Toutes les données</code> est activé.</span>
                {{end}}
                <label for="switchMode">
                    Toutes
                    <!-- plus square -->
                    <svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="/img/icons.svg#feather-plus-square"></use></svg>
                    {{if .Checked}}
                        <input type="checkbox" id="switchMode" name="switchMode" role="switch" checked />
                    {{else}}
                        <input type="checkbox" id="switchMode" name="switchMode" role="switch" />
                    {{end}}
                    <!-- green check square -->
                    <svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="/img/icons.svg#feather-green-check-square"></use></svg>
                    Validées uniquement
                </label><br> <!-- br for smartphone UI -->
            </div>
            <div>
                <!-- Number -->
                <label for="annee"><b>Année</b></label>
                <input type="number" id="annee" name="annee" min="1900" max="2200" step="1" value="{{.Year}}" />
            </div>
        </div>
    </form>
</section>

<section id="account-stats">
    <div>
        <figure>
            <h5>Détail des Comptes</h5>
            <table role="grid">
                <thead>
                    <tr>
                        <th scope="col">Compte</th>
                        <th scope="col" class="right">Prix</th>
                        <th scope="col" class="right">Quantite</th>
                    </tr>
                </thead>
                <tbody>
                    {{range $A := .AccountList}}
                        <tr>
                        {{range $i, $v := $A}} 
                            <td class="col{{$i}}">{{$v}}</td>
                        {{end}}
                        </tr>
                    {{end}}
                    <tr>
                        <td>---</td>
                        <td class="right">---</td>
                        <td class="right">---</td>
                    </tr>
                    <tr>
                        <td>TOTAUX</td>
                        {{range $i, $v := .TotalAccount}} 
                            <td class="right">{{$v}}</td>
                        {{end}}
                    </tr>
                </tbody>
            </table>
        </figure>
    </div>
</section>

<section id="graph-expenses">
    <h5>Principales dépenses par Catégorie</h5>
    <div id="container"></div>
</section>

<section id="category-stats">
    <div>
        <figure>
            <h5>Détail complet par Catégorie</h5>
            <table role="grid">
                <thead>
                    <tr>
                        <th scope="col">Categorie</th>
                        <th scope="col" class="right">Prix</th>
                        <th scope="col" class="right">Quantite</th>
                    </tr>
                </thead>
                <tbody>
                    {{range $C := .CategoryList}}
                        <tr>
                        {{range $i, $v := $C}} 
                            <td class="col{{$i}}">{{$v}}</td>
                        {{end}}
                        </tr>
                    {{end}}
                    <tr>
                        <td>---</td>
                        <td class="right">---</td>
                        <td class="right">---</td>
                    </tr>
                    <tr>
                        <td>TOTAUX</td>
                        {{range $i, $v := .TotalCategory}} 
                            <td class="right">{{$v}}</td>
                        {{end}}
                    </tr>
                </tbody>
            </table>
        </figure>
    </div>
</section>

{{template "footer" .}}
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

<script type="module">
    //pie chart
    /*const data = [
        {name: "<5", value: 19912018},
        {name: "5-9", value: 20501982},
        {name: "10-14", value: 20679786}
    ];*/
    const data = JSON.parse("{{.ResponseJsonString}}");
    //console.log(data);

    // Specify the chart’s dimensions.
    const width = 500;
    const height = Math.min(width, 500);

    // Create the color scale.
    const color = d3.scaleOrdinal()
        //.domain(data.map(d => d.name))
        .domain(data.map(d => d["name"]))
        .range(d3.quantize(t => d3.interpolateRdYlGn(t * 1.2 + 0.1), data.length)) //.reverse()

    // Create the pie layout and arc generator.
    const pie = d3.pie()
        .sort(null)
        .value(d => d.value);

    const arc = d3.arc()
        .innerRadius(0)
        .outerRadius(Math.min(width, height) / 2 - 1);

    const labelRadius = arc.outerRadius()() * 0.8;

    // A separate arc generator for labels.
    const arcLabel = d3.arc()
        .innerRadius(labelRadius)
        .outerRadius(labelRadius);

    const arcs = pie(data);

    // Create the SVG container.
    const svg = d3.create("svg")
        .attr("width", width)
        .attr("height", height)
        //.attr("viewBox", [-width / 2, -height / 2, width, height])
        .attr("viewBox", [-width / 2, -height / 2, width, height])
        .attr("style", "max-width: 100%; height: auto; font: 18px sans-serif; color: white;");

    // Add a sector path for each value.
    svg.append("g")
        .attr("stroke", "white")
        .selectAll()
        .data(arcs)
        .join("path")
        .attr("fill", d => color(d.data.name))
        .attr("fill-opacity", 0.7)
        .attr("d", arc)
        .append("title")
        .text(d => `${d.data.name}: ${d.data.value.toLocaleString("en-US")}`);

    // Create a new arc generator to place a label close to the edge.
    // The label shows the value if there is enough room.
    svg.append("g")
        .attr("text-anchor", "middle")
        .selectAll()
        .data(arcs)
        .join("text")
        .attr("transform", d => `translate(${arcLabel.centroid(d)})`)
        .call(text => text.filter(d => (d.endAngle - d.startAngle) > 0.15).append("tspan")
            .attr("y", "-0.4em")
            //.attr("font-weight", "bold")
            .text(d => d.data.name))
        .call(text => text.filter(d => (d.endAngle - d.startAngle) > 0.25).append("tspan")
            .attr("x", 0)
            .attr("y", "0.7em")
            .attr("fill-opacity", 0.7)
            .text(d => "-"+d.data.value.toLocaleString("fr-FR"))); // "fr-FR"=2 600,72 "en-US"=2,600.72

    container.append(svg.node());

</script>

<!--  
<script type="module">
    //bar chart
    /*var chartData = [
        {name: "A", value: 10},
        {name: "B", value: 50},
        {name: "C", value: 100},
    ];*/
    var chartData = JSON.parse("{{.ResponseJsonString}}");
    //console.log(data);

  // Specify the chart’s dimensions, based on a bar’s height.
  const barHeight = 70;
  const marginTop = 50;
  const marginRight = 20;
  const marginBottom = 10;
  const marginLeft = 200;
  const width = 928;
  const height = Math.ceil((chartData.length + 0.1) * barHeight) + marginTop + marginBottom;

  // Create the scales.
  const x = d3.scaleSymlog()
      .constant(10)
      .domain([0, d3.max(chartData, d => d.value)])
      .range([marginLeft, width - marginRight]);
  
  const y = d3.scaleBand()
      .domain(d3.sort(chartData, d => -d.value).map(d => d.name))
      .rangeRound([marginTop, height - marginBottom])
      .padding(0.1);

  // Create a value format.
  //const format = x.tickFormat(20, "%");
  const format = x.tickFormat(20);

  // Create the SVG container.
  const svg = d3.create("svg")
      .attr("width", width)
      .attr("height", height)
      .attr("viewBox", [10, 10, width, height])
      .attr("style", "max-width: 100%; height: auto; font: 25px sans-serif;");
  
  // Append a rect for each name.
  svg.append("g")
      .attr("fill", "steelblue")
    .selectAll()
    .data(chartData)
    .join("rect")
      .attr("x", x(0))
      .attr("y", (d) => y(d.name))
      .attr("width", (d) => x(d.value) - x(0))
      .attr("height", y.bandwidth());
  
  // Append a label for each name.
  svg.append("g")
      .attr("fill", "white")
      .attr("text-anchor", "end")
    .selectAll()
    .data(chartData)
    .join("text")
      .attr("x", (d) => x(d.value))
      .attr("y", (d) => y(d.name) + y.bandwidth() / 2)
      .attr("dy", "0.35em")
      .attr("dx", -4)
      .text((d) => format(d.value))
    .call((text) => text.filter(d => x(d.value) - x(0) < 20) // short bars
      .attr("dx", +4)
      .attr("fill", "black")
      .attr("text-anchor", "start"));

  // Create the axes.
  svg.append("g")
      .attr("transform", `translate(0,${marginTop})`)
      .style("font-size", "20px")
      //.call(d3.axisTop(x).ticks(width / 80, "%"))
      .call(d3.axisTop(x).ticks(width / 200, "s"))
      .call(g => g.select(".domain").remove());

  svg.append("g")
      .attr("transform", `translate(${marginLeft},0)`)
      .style("font-size", "30px")
      .call(d3.axisLeft(y).tickSizeOuter(0));

  container.append(svg.node());
</script>
-->
<script>
    document.getElementById('switchMode').addEventListener('click', function(evt){
        document.getElementById("form").submit();
    });
    document.getElementById('annee').addEventListener('change', function(evt){
        console.log("in oninput evt")
        document.getElementById("form").submit();
    });
</script>